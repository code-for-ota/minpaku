<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD7B0ZTz7BZZLQ4E7cPD77Ns2mih7u3y5U&callback=initMap">
</script>

<h1>Main Page</h1>
<table>
  <thead>
    <tr>
      <th>id</th>
      <th>アンケートフォーム</th>
    </tr>
  </thead>
  <tbody>
    <% @minpaku_list.each do |minpaku| %>
    <tr>
      <td><%= minpaku.id %></td>
      <td><%= link_to minpaku.name, survey_path(minpaku_id: minpaku.id) %></td>
    </tr>
    <% end %>
  </tbody>
</table>

<div id="map"></div>


<script>
  function initMap() {
    var latlng = new google.maps.LatLng(gon.minpaku_all[0].latitude, gon.minpaku_all[0].longtitude); //中心の緯度, 経度
    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 14, //ズームの調整
      center: latlng //上で設定した中心
    });

    var markers = [];
    var info_windows = [];

    for (var i = 0; i < gon.minpaku_all.length; i++) {
      markers[i] = new google.maps.Marker({
        position: new google.maps.LatLng(gon.minpaku_all[i].latitude, gon.minpaku_all[i].longtitude),
        map: map
      });

      var html = `<div class="modal">

                    <div class="minpaku_name_area">
                      <div class="home_icon_modal">
                        <img src="/assets/main/modal/home_icon_modal.png" widtth="40" height="40">
                      </div>
                      <div class="minpaku_name">
                      ` + gon.minpaku_all[i].name + `
                      </div>
                    </div>

                    <div class="minpaku_location_area">
                      <div class="address_modal">
                        <img src="/assets/main/modal/address_modal.png" widtth="30" height="30">
                      </div>
                      <div class = "address_area">
                        <div class ="postal_code">
                        〒 ` + gon.minpaku_all[i].postal_code + `
                        </div>
                        <div class="address_full">
                        ` + gon.minpaku_all[i].prefecture + gon.minpaku_all[i].city + gon.minpaku_all[i]
        .address_details + `
                        </div>
                      </div>
                    </div>

                    <div class="aggregate_values" id="minpaku_id_` + gon.minpaku_all[i].id + `">
                    </div>

                  </div>`;

      info_windows[i] = new google.maps.InfoWindow({
        content: html
      });

      google.maps.event.addListener(markers[i], 'click', (function (i) {
        return function () {
          info_windows[i].open(map, markers[i]);
          add_aggregate_values_dom(gon.minpaku_all[i].id)
        };
      })(i));

      function add_aggregate_values_dom(id) {
        var request = new XMLHttpRequest();
        request.open('GET', "/get_aggregate_values/" + id, true);
        request.onload = function () {
          insert_target = document.getElementById("minpaku_id_" + id);
          insert_target.innerHTML = radar_chart_html_builder(this.response);
        }
        request.send()
      }

      function radar_chart_html_builder(response) {
        var html = "";
        var aggregate_values = JSON.parse(response)
        aggregate_values.forEach(aggregate_value => {
          html += `
            <div>` +
            aggregate_value.survey_name + ` : ` + aggregate_value.average + `
            </div>
            `;
        });
        return html;
      }
    }

  }
</script>